#pragma once

#include "ofMain.h"
using std::vector;

// === 天気の種類 ===
enum WeatherType {
    WEATHER_SUNNY,
    WEATHER_CLOUDY,
    WEATHER_RAINY,
    WEATHER_SNOWY,
    WEATHER_THUNDERSTORM,
};

class ofApp : public ofBaseApp {
public:
    void setup();
    void update();
    void draw();
    void keyPressed(int key);

private:
    // =============================
    //  天気・環境
    // =============================
    WeatherType currentWeather;

    // =============================
    //  基本 CA グリッドパラメータ
    // =============================
    int cellSize;
    int caCols;
    int caRows;

    // =============================
    //  天気用セルオートマトン
    // =============================
    vector<vector<int>>  ca;
    vector<vector<int>>  caNext;

    // ★ 各セルの強さ（勝者ルール用）
    vector<vector<float>> caStrength;

    float caUpdateInterval;
    float caTimer;

    void randomizeCA();
    void updateCA();  // 勝者ルール＋カオス生成を含む
    void drawCA();


    // =============================
    //  雲 用 CA
    // =============================
    vector<vector<int>>  cloudCA;
    vector<vector<int>>  cloudNext;

    float cloudUpdateInterval;
    float cloudTimer;

    void updateCloudCA();
    void drawCloudCA();


    // =============================
    //  ベクトル場（天候による風）
    // =============================
    vector<vector<ofVec2f>> flowField;
    float flowTime;

    void generateFlowFieldForCurrentWeather();
    void getFlowDirForCell(int gx, int gy, int& dx, int& dy);


    // =============================
    //  カオス天気制御
    // =============================
    double chaosX;      // ロジスティック写像（0〜1）
    double chaosR;      // カオスパラメータ（3.8〜4.0）
    float  weatherTimer;
    float  weatherBaseMin;
    float  weatherBaseMax;

    void stepChaos();
    void updateWeatherByChaos();
    void applyWeatherStep(int step, bool forceThunder);


    // =============================
    //  雲の量子ブロブ
    // =============================
    void drawCloudBlob(float cx, float cy,
        float baseR,
        const ofColor& baseColor,
        float seed);

    void drawNoisyPolygon(float cx, float cy,
        float baseRadius,
        int sides,
        float rotationRad,
        float noiseScale,
        float noiseAmp,
        float seed,
        float time);


    // =============================
    //  勝者ルール用パラメータ
    // =============================
    float strengthGrowth;            // 勝てば強くなる増加量
    float strengthDecay;             // 時間による減衰
    float chaosClusterBaseStrength;  // カオスクラスタ初期強さ


    // =============================
    //  カオスクラスタ生成（新しい勢力）
    // =============================
    void spawnChaosClustersByChaos(vector<vector<int>>& movedGrid);
    void spawnClusterAt(int cx, int cy, vector<vector<int>>& movedGrid);
};